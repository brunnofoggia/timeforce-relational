import _ from"lodash";import state from"timeforce-state";import mapping from"./mapping.min.js";var relational={key:"relations"},stateMap=state.map,relationMap=relational.map=Object.freeze({...mapping.type,..._.pick(mapping,"instance","name","times")});relational.globalPrototype=_.defaults({relation:Object.freeze({..._.omit(mapping,"prototypes","key")}),relationalInitialize(){this[relational.key]||(this[relational.key]={}),this[mapping.key]||(this[mapping.key]=[]),this.mapRelations()},addRelation(t,e,i={}){return this[relational.key][t]=e,this._setRelationListener(e,i)},addRelationList(t){this[relational.key][t]=[]},addRelationListItem(t,e,i={}){if(_.isArray(this[relational.key][t]))return this[relational.key][t].push(e),this._setRelationListener(e,i)},_setRelationListener(t,e={}){return this._listenToState(t,state.map.type.FETCH,e.listenTo),t},findRelation(t,e){var i=this[relational.key][t],a=e?_.isFunction(e)?e:t=>e+""==t.get(t.idAttribute)+"":null;return _.isArray(i)?a&&(i=_.filter(i,a)):i=[i],i},findRelationBy(t,e,i){return this.findRelation(t,(t=>i+""==t.get(e)+""))},filterAttributesAndFindRelation(t,e){var i,a=this.getRelationMap(t).foreignKey.split("."),n=a.pop();a=a.join("."),i=this.get(a);var o=_.chain(i).filter(e).map((t=>t[n]+"")).value();return this.findRelation(t,(t=>_.indexOf(o,t.get(t.idAttribute)+"")>-1))},matchAttributesAndFindRelations(t,e,i){return this.filterAttributesAndFindRelation(t,(t=>t[e]+""==i+""))},getRelation(t,e){var i=this.findRelation(t,e);return i?i[0]:null},getRelationBy(t,e,i){return this.getRelation(t,(t=>i+""==t.get(e)+""))},_listenToState(t,e,i=0){if(i!==mapping.times.OFF){if(i===mapping.times.ONCE)return this.listenToOnceOff(t,[e,state.map.name[state.map.READY]].join(state.map.eventSplitter),(()=>this.triggerReady(e)),[e,state.map.name[state.map.BROKEN]].join(state.map.eventSplitter),((t,i,a)=>this.triggerBroken(e,t,i,a)));t.on([e,state.map.name[state.map.READY]].join(state.map.eventSplitter),(()=>this.triggerReady(e))),t.on([e,state.map.name[state.map.BROKEN]].join(state.map.eventSplitter),((t,i,a)=>this.triggerBroken(e,t,i,a)))}},relationsReady(){return this._listReady(relational.key)},_listReady(t){var e=this.checkLists(t,state.enum.READY);return this[t+"StateInfo"]=e[1].join(", "),e[0]},_fetchList(t,e,i={}){var a=this[t][e];if(a){var n=_.isArray(a)?a:[a];for(var o in n){let t=n[o],a=this.getRelationMap(e)||{};a.fetch===mapping.times.OFF||a.fetch===mapping.times.ONCE&&t.isReady()||t[this.defineRelationFetchMethod(a)](i)}}},fetchRelation(t,e={}){return this._fetchList("relations",t,e)},fetchAllRelations(t={}){if(_.size(this[relational.key])){for(var e in this[relational.key])this.fetchRelation(e,t);return!0}return!1},fetchAll(){return new Promise(((t,e)=>{this.onceOff([state.map.type.FETCH,state.map.name[state.map.READY]].join(state.map.eventSplitter),(()=>t()),[state.map.type.FETCH,state.map.name[state.map.BROKEN]].join(state.map.eventSplitter),((t,i,a)=>e({model:t,response:i,options:a}))),(!this.isModel()||this.id)&&this.fetch(),this.fetchAllRelations()}))}},mapping.prototypes,state.globalPrototype),relational.modelPrototype=_.defaults({isReady(){return _.bind(state.modelPrototype.isReady,this)()&&this.relationsReady()},hasError(){return _.bind(state.modelPrototype.hasError,this)()||!1===this.relationsReady()}},state.modelPrototype),relational.collectionPrototype=_.defaults({isReady(){return _.bind(state.collectionPrototype.isReady,this)()&&this.relationsReady()},hasError(){return _.bind(state.collectionPrototype.hasError,this)()||!1===this.relationsReady()},modelsReady(){var t=!0,e=this.checkLists("models",state.enum.READY);return this.infoModelsReady="",e[0]||(t=e[0],this.infoModelsReady=e[1].join(", ")),t}},state.collectionPrototype);var mix=relational.mix=function(t,e,i){state.mix(t,e,i),t.relation=relationMap,_.each([[e,_.defaults({},relational.collectionPrototype,relational.globalPrototype)],[i,_.defaults({},relational.modelPrototype,relational.globalPrototype)]],(function(t){var e=t[0],i=t[1];_.each(i,(function(t,i){e.prototype[i]=t})),e.prototype.initializePluginMethods.push("relationalInitialize")}))};export{mix,relationMap as relation,stateMap as state};export default relational;